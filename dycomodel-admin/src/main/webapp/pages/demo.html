
 <!DOCTYPE html>
<html lang="en">
   <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Dynamic Consumption Model</title>
	<link rel="SHORTCUT ICON" href="images/application.ico">

    <!-- Angular Material CSS -->
    <link rel="stylesheet" href="css/angular-material.min.css">


  </head>


  <body>
 
	<div layout="column" layout-fill id="demo" ng-app="demoApp" ng-controller="demoCtrl as mc">
    	<md-toolbar md-medium-tall >
	   		<div class="md-toolbar-tools">
		        <h2 flex md-truncate>DYNAMIC CONSUMPTION MODEL <i><font size="2">(only Chrome browser supported)</font></i></h2>	
	    	</div>
		</md-toolbar>
	  	<md-content>
			<md-tabs md-dynamic-height md-border-bottom md-stretch-tabs>
		    	<md-tab label="STEP 1 - Forecasting" md-on-select="selectTabApproximation()" md-active="view.model.page_tab == 0">
		        	<md-content class="md-padding_">
		        		<div layout="row">
		        			<div flex layout-padding >
								<section >
									<md-toolbar class="md-primary _md _md-toolbar-transitions">	
										<div class="md-toolbar-tools">
											<h2 flex md-truncate>Input chanel from Customer's infrastructure</h2>	
									    </div>     
									</md-toolbar>
								</section>      	        			
							</div>
							<div flex layout-padding >
								<section >
									<md-toolbar class="md-primary _md _md-toolbar-transitions">	
										<div class="md-toolbar-tools">
											<h2 flex md-truncate>Consumption:<br> {{view.model.forecastingStartDate}} - {{view.model.forecastingFinishDate}}</h2>	
									    </div>     
									</md-toolbar>
								</section>
							</div>
							<div flex layout-padding>	
								<section >
									<md-toolbar class="md-primary _md _md-toolbar-transitions" style="background-color:transparent; color: black;">	
										<md-input-container class="md-block">
								         	<label>Average forecasted consumption</label>
								          	<md-select ng-model="view.model.approximationType">
								            	<md-option ng-repeat="period in view.model.selectApproximationType" ng-value="period.code" >
								              		{{period.desc}}
								            	</md-option>
								         	</md-select>									
		          						</md-input-container>
  									</md-toolbar>
								</section>							
							</div>	
							<div flex layout-padding>	
								<section >
									<md-toolbar class="md-primary _md _md-toolbar-transitions" style="background-color:transparent; color: black;">	
										<md-input-container class="md-block">
											<label>Average Daily Secure Stock</label>
											<input type="number" step="1" name="dayStockDelta" ng-model="view.model.dayStockDelta" min="0" max="30"/>
	          							</md-input-container>
	          							
  									</md-toolbar>
								</section>							
							</div>																						  							        		
		        		</div>
						<div layout="row">
							<div flex layout-padding >
								<div layout-align="center center" style="text-align: center">
									<img src="images/customer_infr.png"/>
								</div>	
							</div>	
							<div flex layout-padding >
								<md-list >
									<md-list-item class="md-2-line" ng-repeat="(key, value) in view.model.rawdata">
										<div class="md-list-item-text">
									    	<h4>{{key | date:'dd/MM/yyyy'}}</h4> 
									      	<p>{{value}}</p>
									   	</div>   	
									</md-list-item>
								</md-list>
							</div>
							<div flex layout-padding>	
								<md-list>
							  		<md-list-item class="md-2-line" ng-repeat="consumption in view.model.sliders.consumption">
										<md-checkbox ng-model="consumption.done"></md-checkbox>
										<div class="md-list-item-text">
										    <h3>{{consumption.desc}}</h3>
										   	<p>{{consumption.value}}</p>
									 	</div>
									</md-list-item>									
								</md-list>	
							</div>	
							<div flex layout-padding>	
								<md-list >
							  		<md-list-item class="md-2-line" ng-repeat="stock in view.model.sliders.stock" ng-if="view.model.redraworders==false">
										<md-checkbox ng-model="stock.done"></md-checkbox>
										<div class="md-list-item-text">
											<h3>{{stock.desc}}</h3>
										    <p>{{stock.value}}</p>
										</div>
									</md-list-item>	
									<md-progress-linear class="md-primary" md-mode="indeterminate" ng-if="view.model.redraworders==true"/>								
								</md-list>	
								
							</div>	
						</div>									
		        	</md-content>
				</md-tab>
		      	<md-tab label="STEP 2 - Correction & Prediction" md-on-select="selectTabForecasting()" md-active="view.model.page_tab == 1">
			    	<md-content class="md-padding">
			        	<div id="chartavr_div" style="width: 1250px; height: 220px;"></div>
						<div id="tuning_div" style="padding:0px;">
						<table  cellspacing="0" cellpadding="0" >
							<tr>
								<td style="min-width:86px;" data-ng-repeat="consumption in view.model.sliders.consumption" ng-if="view.model.tunemode==1">
									<md-slider-container flex>
										<md-input-container>
											<input flex type="number" ng-model="consumption.value" aria-label="consumption" aria-controls="consumption-slider" > 
										</md-input-container>
										<md-slider 	md-discrete ng-model="consumption.value" min="{{view.model.sliders.minC}}" max="{{view.model.sliders.maxC}}" step="1"
													id="consumption-slider"
													aria-label="bass" class="md-primary"
													md-vertical             	
													style="padding:0px;height:50px"
													></md-slider>
								      	<h5>{{consumption.desc}}</h5>
									</md-slider-container>	
								</td>			
							</tr>
							<tr >
								<td style="min-width:86px;" data-ng-repeat="stock in view.model.sliders.stock" ng-if="view.model.tunemode == 2">
									<md-slider-container flex>
										<md-input-container>
											<input flex type="number" ng-model="stock.value" aria-label="stock" aria-controls="stock-slider" > 
										</md-input-container>
										<md-slider 	md-discrete ng-model="stock.value" min="{{view.model.sliders.minS}}" max="{{view.model.sliders.maxS}}" step="1" 
												      id="stock-slider"
												      aria-label="stock" class="md-accent"
												       md-vertical md-range></md-slider>
									      <h5>{{stock.desc}}</h5>
									</md-slider-container>										
								</td>
							</tr>
						</table>
					</div>
					<md-radio-group ng-model="view.model.tunemode" layout="row">
						<md-radio-button value="0" class="md-warn"> Hide </md-radio-button>
						<md-radio-button value="1" class="md-primary"> Consumption </md-radio-button>
						<md-radio-button value="2" class="md-accent"> Secure Stock </md-radio-button>							
					</md-radio-group>   							
				</md-content>
			</md-tab>
				<md-tab label="STEP 3 - Orders Processing" md-on-select="selectTabProcessing()" md-active="view.model.page_tab == 2">
			        <md-content class="md-padding">
						<div layout="column">
							<div layout="row">
								<div flex >
									<md-radio-group ng-model="view.model.calculatemode" layout="row">
										<md-radio-button value="1" class="md-primary"> First Point </md-radio-button>
										<md-radio-button value="2" class="md-accent"> Fixed Quantity </md-radio-button>	
										<md-radio-button value="3" class="md-accent"> Fixed Dates </md-radio-button>							
									</md-radio-group>  		
								</div>
								<div flex>
									<md-input-container class="md-block">
										<label>Initial Quantity</label>
										<input type="number" step="100" name="quantity" ng-model="view.model.quantity" min="0" max="100000"/>
									</md-input-container> 		
								</div>								
								<div flex>
									<md-input-container class="md-block" ng-if="view.model.calculatemode==2">
										<label>Fixed Quantity</label>
										<input type="number" step="100" name="quantity" ng-model="view.model.fixedQuantity" min="0" max="100000"/>
									</md-input-container>	
									<md-input-container class="md-block" ng-if="view.model.calculatemode==3">
							          	<label>Periodicity</label>
							          	<md-select ng-model="view.model.fixedPeriod">
							            	<md-option ng-repeat="period in view.model.selectFixedPeriod" ng-value="period.code" >
							              		{{period.desc}}
							            	</md-option>
							         	</md-select>									
	          						</md-input-container>												
								</div>
				   			</div>
							<div flex >     
						    	<div id="chartcons_div" style="height: 270px;" ></div> 
						        	<div style="height: 5px;" >
						          		<md-progress-linear md-mode="indeterminate" ng-if="view.model.chartsInProgress==true"/>
						          	</div>
									<md-slider-container >
										<span class="md-body-1">Zoom</span>
										<md-slider flex md-discrete ng-model="view.model.dayFinishDate" step="1" min="0" max="365" aria-label="dayFinishDate" id="dayFinishDate-slider" class="md-primary">
										</md-slider>
										<md-input-container>
											<input flex type="number" ng-model="view.model.dayFinishDate" aria-label="dayFinishDate" aria-controls="dayFinishDate-slider">
										</md-input-container>
									</md-slider-container>		          	
						    </div>
							<div layout="row">
								<div flex layout-padding>
									<md-slider-container >
										<span class="md-body-1">Lead</span>
										<md-slider flex md-discrete ng-model="view.model.leadDays" step="1" min="0" max="90" 
													aria-label="leadDays" 
													id="leadDays-slider" 
													class="md-primary"
										>
										</md-slider>
										<md-input-container>
											<input flex type="number" ng-model="view.model.leadDays" aria-label="leadDays" aria-controls="leadDays-slider">
										</md-input-container>
									</md-slider-container>	
									<md-slider-container >
										<span class="md-body-1">Items x Pack</span>
										<md-slider flex md-discrete ng-model="view.model.itemsForPack" step="1" min="1" max="100" 
													aria-label="itemsForPack" 
													id="itemsForPack-slider" 
													class="md-primary"
										>
										</md-slider>
										<md-input-container>
											<input flex type="number" ng-model="view.model.itemsForPack" aria-label="itemsForPack" aria-controls="itemsForPack-slider">
										</md-input-container>
									</md-slider-container>											          	
									<md-slider-container >
										<span class="md-body-1">Scale</span>
										<md-slider flex md-discrete ng-model="view.model.chartConsumptionDayInterval" step="1" min="1" max="7" 
													aria-label="chartConsumptionDayInterval" 
													id="chartConsumptionDayInterval-slider" 
													class="md-primary"
										>
										</md-slider>
										<md-input-container>
											<input flex type="number" ng-model="view.model.chartConsumptionDayInterval" aria-label="chartConsumptionDayInterval" aria-controls="chartConsumptionDayInterval-slider">
										</md-input-container>
									</md-slider-container>		        
								</div>
								<div flex layout-padding>
									<section >
										<md-toolbar class="md-warn _md _md-toolbar-transitions">	
											<div class="md-toolbar-tools">
												<h2 flex md-truncate>Procurement orders ready to send - {{view.model.orders.length}}</h2>	
										    </div>     
										</md-toolbar>
										<md-list flex layout-padding >
											<md-list-item class="md-2-line" ng-repeat="item in view.model.orders"  ng-if="view.model.redraworders==false">
												<md-checkbox ng-model="item.done"></md-checkbox>
											    <div class="md-list-item-text">
											    	<h3>{{item.date}}</h3>
											      	<p>{{item.quantity}}</p>
											    </div>									    
											</md-list-item>
											<md-progress-linear class="md-warn" md-mode="indeterminate" ng-if="view.model.redraworders==true"/>
										</md-list>
										
									</section>								
								</div>
								<div flex layout-padding >	
									<section >
										<md-toolbar class="md-primary _md _md-toolbar-transitions">	
											<div class="md-toolbar-tools">
												<h2 flex md-truncate>Output chanel to Customer's infrastructure</h2>	
										    </div>     
										</md-toolbar>
										<div layout-align="center center" style="text-align: center">
											<img src="images/customer_infr_out.png"/>
										</div>										
									</section> 								
								
								</div>		
							</div>
						</div>
			       	</md-content>
		      	</md-tab>
		   	</md-tabs>
		</md-content>
	</div>

    
	<!--  Angular 1.5 JavaScript -->
	<script src='js/angular.min.js'></script>
	<script src='js/angular-animate.min.js'></script>
	<script src='js/angular-aria.min.js'></script>
	<script src='js/angular-material.min.js'></script>
	
	<!--  ClassHidra Ajax JavaScript -->
	<script src='js/clAjax.js'></script>  	
	
	<!--  ClassHidra Model JavaScript -->
	<script src='js/clModels.js'></script>	
	
	<!--  Google charts -->
	<script src="js/chart_loader.js"></script>
	

	 
	
	
	<script>
	
//    google.charts.load('current', {'packages':['corechart']});
//    google.charts.setOnLoadCallback(function(){drawChart();});


	function chartInLoad(id, inLoad){
//		return;
//		var div = document.getElementById(id);
		
		try{
			if(inLoad==true){
//				div.style.opacity = .1;
//				div.style.filter = "alpha(opacity=10)";
				getScope().view.model.chartsInProgress=true;
			}else{
//				div.style.opacity = 1;
//				div.style.filter = "alpha(opacity=100)";
				setTimeout(
						function(){
							getScope().view.model.chartsInProgress=false;
						},
						100
				);		
			}
		}catch(e){
			
		}
	}
    
    function drawChartAverage(datas){
    	var arr = new Array();
    	arr[0] = datas["chart"].header;
    	datas["chart"].datas.forEach(
    			function(item, index){
    				arr[index+1] = new Array();
    				arr[index+1][0]=new Date(item[0]);
    				arr[index+1][1]=Number(item[1]);
    				arr[index+1][2]=Number(item[2]);
    			}
    	);
        var data = google.visualization.arrayToDataTable(arr);

		var options = {
			title_: 'Average Consumption/Secure stock',
			curveType: 'function',
			legend: { position: 'top' },
			hAxis: { textPosition: 'none' },
			'chartArea':{left:50,top:25,bottom:5,width:"100%"}

		};

		var chart = new google.visualization.LineChart(document.getElementById('chartavr_div'));
		chart.draw(data, options);
		chartInLoad("chartavr_div",false);
    }
    
    function drawChartConsumption(datas){
    	var arr = new Array();
    	arr[0] = datas["chart"].header;
    	datas["chart"].datas.forEach(
    			function(item, index){
    				arr[index+1] = new Array();
    				arr[index+1][0]=new Date(item[0]);
    				arr[index+1][1]=Number(item[1]);
	   				arr[index+1][2]=Number(item[2]);
	   				arr[index+1][3]=Number(item[3]);
    			}
    	);
        var data = google.visualization.arrayToDataTable(arr);

		var options = {
			title_: 'Consumption',
			curveType_: 'function',
			legend: { position: 'top' },
			hAxis_: { textPosition: 'none' },
			vAxis: {viewWindowMode: "explicit", viewWindow:{ min: 0 }},
			seriesType: 'line',
			series: {2: {type: 'bars', color_: 'green'}},
			'chartArea':{left:75,top:30,bottom:25,width:"100%"}

		};

		var chart = new google.visualization.LineChart(document.getElementById('chartcons_div'));
		chart.draw(data, options);
		chartInLoad("chartcons_div",false);
    }    

	

	var ServerModel = {
		rawdata : [],
		sliders : [],
		orders : [],
		selectFixedPeriod: [],
		selectApproximationType: [],
		approximationType: 1,
		fixedPeriod: '',
		proxy: {},
		chartsInProgress: false,
		redrawcharts: false,
		redraworders: false,
		tunemode: 1,
		calculatemode: 1,
		dayFinishDate: 0,
		chartConsumptionDayInterval: 1,
		page_tab: 1,
		quantity: 0.0,
		fixedQuantity: 0.0,
		leadDays: 15,
		itemsForPack: 1,
		dayStockDelta: 0,
		forecastingStartDate: '',
		forecastingFinishDate: '',
		error : '',
		warning : '',
		info : '',
		success: '',
		
		init: function(model){
			json2model(this,model);
		},
		
	
		message : function(){
			if(this.error && this.error!=''){
				new clpopup({
					type: 'danger',
					message: this.error
				}).open();					 
			}
			if(this.success && this.success!=''){
				new clpopup({
					type: 'success',
					message: this.success
				}).open();					 
			}	
			if(this.info && this.info!=''){
				new clpopup({
					type: 'info',
					message: this.info
				}).open();					 
			}
			if(this.warning && this.warning!=''){
				new clpopup({
					type: 'warning',
					message: this.warning
				}).open();					 
			}			
		}
					
	}
	
	var ViewModel = function(serverModel) {
		var self = this;
		self.initialisation = true;
		self.model = serverModel;
		
		self.init = function(parsed){
			self.initialisation = true;
			try{
				self.model.init(parsed.model);
			}catch(e){
				showException(e);
			}
			self.initialisation = false;					
		}
		
		self.post = function($http,newValue){
			if(!self.initialisation){
				
				$http.post('demo-json', JSON.stringify(newValue)).
			    success(function(data, status, headers, config) {
			    	self.init(data);
			      }).
			      error(function(data, status, headers, config) {
			    	  console.log(data);
			      });
				

			}			
		}
	
		self.postDirty = function($http,$timeout,newValue){
			if(!self.initialisation){
				$http.post('demo-diff', JSON.stringify(newValue)).
			    success(function(data, status, headers, config) {
			    	if(data.model.redrawcharts)
			    		self.model.redrawcharts = data.model.redrawcharts;
			    	if(data.model.redraworders)
			    		self.model.redraworders = data.model.redraworders;
			    	if(self.model.approximationType!='1')
			    		self.model.approximationType='1';

//			    	self.init(data);
					if(self.model.redraworders==true){
//						self.model.redraworders=false;
			    		if(self.model.page_tab==0){
			    			$http({
			    	            method : 'GET',
			    	            url : 'demo-json'
			    		    }).success(function(data, status, headers, config) {
//			    		    	getScope().view.init(data);	
								if(data.model.sliders)
			    		    		self.model.sliders = data.model.sliders;
			    		    });
			    		}						
					}
			    	if(self.model.redrawcharts==true){
			    		self.model.redrawcharts=false;

			    		if(self.model.page_tab==1){
			    			chartInLoad("chartavr_div",true);
				    		$http({
				                method : 'GET',
				                url : 'demo-chartavr'
				    	    }).success(function(data, status, headers, config) {
//				    	        google.charts.load('current', {'packages':['corechart']});
				    	        google.charts.setOnLoadCallback(function() {drawChartAverage(data);});
								$timeout(
										function(){
											self.model.redraworders=false;
										},
										500
								);
				    	    }).error(function(data, status, headers, config) {
				    	    	chartInLoad("chartavr_div",false);
				    	    });
			    		}
			    		if(self.model.page_tab==2){
			    			chartInLoad("chartcons_div",true);
				    		$http({
				                method : 'GET',
				                url : 'demo-chartcons'
				    	    }).success(function(data, status, headers, config) {
//				    	        google.charts.load('current', {'packages':['corechart']});
				    	        google.charts.setOnLoadCallback(function() {drawChartConsumption(data);});
				    	        
				    	        $http({
				    	            method : 'GET',
				    	            url : 'demo-json'
				    		    }).success(function(data, status, headers, config) {
//				    		    	getScope().view.init(data);	
									if(data.model.orders)
				    		    		self.model.orders = data.model.orders;
									
									$timeout(
											function(){
												self.model.redraworders=false;
											},
											500
									);
				    		    });
				    	    }).error(function(data, status, headers, config) {
				    	    	chartInLoad("chartcons_div",false);
				    	    	self.model.redraworders=false;
				    	    });
			    		}
			    		
			    	}else{
			    		if(self.model.redraworders==true){
			    			$http({
			    	            method : 'GET',
			    	            url : 'demo-json'
			    		    }).success(function(data, status, headers, config) {
//			    		    	getScope().view.init(data);	
								if(data.model.orders)
			    		    		self.model.orders = data.model.orders;
								$timeout(
										function(){
											self.model.redraworders=false;
										},
										500
								);
				    	    }).error(function(data, status, headers, config) {
				    	    	self.model.redraworders=false;
				    	    });
			    		}
			    	}
			      }).
			      error(function(data, status, headers, config) {
			    	  console.log(data);
			      });
			}			
		}		
		
		self.getDirty = function(oldModel){
			var result = [];
			dirtyModelElements(self,oldModel,result);
			return result;
		}
		
		self.message = function(){
			self.model.message();
		}
	}
	
	function getScope(){
		return angular.element(document.getElementById("demo")).scope();
	}
	
	var app = angular.module('demoApp', ['ngMaterial']);
	
	app.service('Browsertype', ['$window', function($window) {
		this.type = function() {
	        var userAgent = $window.navigator.userAgent;
	        var browsers = {chrome: /chrome/i, safari: /safari/i, firefox: /firefox/i, ie: /internet explorer/i};
	        for(var key in browsers) {
	            if (browsers[key].test(userAgent)) {
	                return key;
	            }
	       };
	       return 'unknown';
	    }

	}]);

	app.controller('demoCtrl', function($scope, $http, $browser, $timeout, Browsertype) {

		$scope.view = new ViewModel(ServerModel);
		
		$scope.selectTabApproximation = function() {
			$scope.view.model.page_tab = 0;
		}
		
		$scope.selectTabProcessing = function() {

			$scope.view.model.page_tab = 2;
		    $http({
                method : 'GET',
                url : 'demo-chartcons'
    	    }).success(function(data, status, headers, config) {
//    	        google.charts.load('current', {'packages':['corechart']});
    	        google.charts.setOnLoadCallback(function() {drawChartConsumption(data);});
    	        $http({
    	            method : 'GET',
    	            url : 'demo-json'
    		    }).success(function(data, status, headers, config) {
//    		    	getScope().view.init(data);	
					if(data.model.orders)
						getScope().view.model.orders = data.model.orders;
    		    });
    	        
    	    });
		}
		$scope.selectTabForecasting = function() {
			$scope.view.model.page_tab = 1;
		    $http({
                method : 'GET',
                url : 'demo-chartavr'
    	    }).success(function(data, status, headers, config) {
//    	        google.charts.load('current', {'packages':['corechart']});
    	        google.charts.setOnLoadCallback(function() {drawChartAverage(data);});
    	    });
		}

		
		$http({
            method : 'GET',
            url : 'demo-json'
	    }).success(function(data, status, headers, config) {
	    	getScope().view.init(data);
	    	if(getScope().view.model.redraworders==true)
	    		getScope().view.model.redraworders=false;
	    	getScope().$watch('view', function(newValue, oldValue) {
	    		var diff = newValue.getDirty(oldValue,function(property){
	    			if(property && 
		    				(
		    					property.indexOf('$$')>=0 ||
		    					property=='error' ||
		    					property=='info' ||
		    					property=='warning'||
		    					property=='success' ||
		    					property=='redrawcharts'
		    				)
		    			)
		    				return true;
		    			return false;
		    		});
				if(diff.length>0)
					$scope.view.postDirty($http,$timeout,diff);
	  		},true);
  		
	    	
	    }).error(function(data, status, headers, config) {

	    });	
		if($scope.view.model.page_tab==1){
			$http({
	            method : 'GET',
	            url : 'demo-chartavr'
		    }).success(function(data, status, headers, config) {
		        google.charts.load('current', {'packages':['corechart']});
		        google.charts.setOnLoadCallback(function() {drawChartAverage(data);});
		    });
		}
	});
	

	
	</script>
  </body>
</html>